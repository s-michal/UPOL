(define-syntax set-car!
  (syntax-rules ()
    ((_ l new_car) (set! l (cons new_car (cdr l))))))

(define-syntax set-cdr!
  (syntax-rules ()
    ((_ l new_cdr) (set! l (cons (car l) new_cdr)))))

;-------------------------------------------------------------------
;REVERSE
(define swap-mpair
  (lambda (p)
    (let ((first (mcar p)))
      (set-mcar! p (mcdr p))
      (set-mcdr! p first))))

(define depth-reverse!
  (lambda (list)
    (let ((processed '()))
      (let iter ((l list))
        (if (mpair? l)
        (when (not (memq l processed))
              (set! processed (cons l processed))
              (swap-mpair l)
              (iter (mcar l))
              (iter (mcdr l))))))))


(define t (mcons (mcons 1 2) (mcons 'a 'b)))
;t
(depth-reverse! t)

;DLIST
(define cons-dlist
  (lambda (elem dlist)
    (let ((new-cell (cons elem (cons '() dlist))))
      (if (not (null? dlist))
          (set-car! (cdr dlist) new-cell))
      new-cell)))


(define r (cons-dlist 'a 'b))